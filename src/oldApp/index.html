<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPP Digital Assistant</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1586.0.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0,136,168,0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .chat-container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,174,213,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 750px;
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
            animation: containerFadeIn 0.5s ease-out;
        }
        
        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .chat-header {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9fc 100%);
            color: #333;
            padding: 24px 30px;
            display: flex;
            align-items: center;
            gap: 18px;
            border-bottom: 3px solid #00AED5;
            box-shadow: 0 2px 8px rgba(0,174,213,0.08);
            position: relative;
        }
        
        .chat-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #00AED5 0%, #0088A8 50%, #00AED5 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .chat-header-logo {
            height: 56px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,174,213,0.2));
            transition: transform 0.3s ease;
        }
        
        .chat-header-logo:hover {
            transform: scale(1.05);
        }
        
        .chat-header-text {
            flex: 1;
            text-align: left;
        }
        
        .chat-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #00AED5;
            letter-spacing: -0.02em;
        }
        
        .chat-header p {
            font-size: 13px;
            opacity: 0.75;
            color: #555;
            line-height: 1.4;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #10b981;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: linear-gradient(to bottom, #fafbfc 0%, #f5f7f9 100%);
            scroll-behavior: smooth;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #00AED5;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            animation: messageSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            max-width: 75%;
        }
        
        .message.user .message-wrapper {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.bot .message-avatar {
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            color: white;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        
        .message-content {
            padding: 14px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            max-width: 100%;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .message-content:hover {
            transform: translateY(-2px);
        }
        
        .message.bot .message-content {
            background: white;
            color: #2d3748;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
            border-bottom-left-radius: 4px;
            line-height: 1.6;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }
        
        .message.bot .message-content:hover {
            box-shadow: 0 4px 12px rgba(0, 174, 213, 0.15), 0 2px 6px rgba(0, 0, 0, 0.08);
        }
        
        .message.bot .message-content ul {
            margin: 10px 0;
            padding-left: 20px;
            list-style-type: none; /* Remove default bullets */
        }
        
        .message.bot .message-content li {
            margin: 8px 0;
            line-height: 1.7;
            position: relative;
            padding-left: 24px; /* Space for custom bullet */
        }
        
        .message.bot .message-content li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #00AED5;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.7;
        }
        
        /* Add breathing room between bullets */
        .message.bot .message-content li + li {
            margin-top: 14px;
        }
        
        /* Paragraph spacing for natural flow */
        .message.bot .message-content p {
            margin: 0 0 12px 0;
            line-height: 1.7;
        }
        
        .message.bot .message-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Visual separation between paragraphs and lists */
        .message.bot .message-content p + ul,
        .message.bot .message-content ul + p {
            margin-top: 16px;
        }
        
        .message.bot .message-content strong {
            font-weight: 600;
            color: #00AED5;
        }
        
        .message.bot .message-content em {
            font-style: italic;
            color: #4a5568;
        }
        
        .message.bot .message-content a {
            color: #00AED5;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .message.bot .message-content a:hover {
            color: #0088A8;
            border-bottom-color: #0088A8;
            background: rgba(0, 174, 213, 0.05);
            padding: 2px 4px;
            margin: -2px -4px;
            border-radius: 4px;
        }
        
        .message.bot .message-content a::after {
            content: ' ‚Üó';
            font-size: 0.85em;
            opacity: 0.6;
        }
        
        /* Sub-heading style for bot messages */
        .message.bot .message-content .sub-heading {
            font-weight: 600;
            color: #2d3748;
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 15px;
            padding-left: 0;
            border-left: 3px solid #00AED5;
            padding-left: 12px;
            background: rgba(0, 174, 213, 0.05);
            padding-top: 6px;
            padding-bottom: 6px;
            border-radius: 4px;
        }
        
        .message.bot .message-content .sub-heading:first-child {
            margin-top: 0;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 174, 213, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1);
            border-bottom-right-radius: 4px;
        }
        
        .message.user .message-content:hover {
            box-shadow: 0 4px 12px rgba(0, 174, 213, 0.4), 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }
        
        .chat-input-container {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
        }
        
        #userInput {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 28px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            background: #fafbfc;
            font-family: 'Inter', sans-serif;
        }
        
        #userInput:focus {
            border-color: #00AED5;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 174, 213, 0.08);
        }
        
        #userInput::placeholder {
            color: #a0aec0;
        }
        
        #sendButton {
            padding: 14px 32px;
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            color: white;
            border: none;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 174, 213, 0.3);
        }
        
        #sendButton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        #sendButton:hover::before {
            left: 100%;
        }
        
        #sendButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 174, 213, 0.4);
        }
        
        #sendButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 174, 213, 0.3);
        }
        
        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #sendButton:disabled::before {
            display: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 14px 20px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-left: 46px;
        }
        
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            border-radius: 50%;
            display: inline-block;
            margin: 0 3px;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-12px);
                opacity: 1;
            }
        }
        
        .error-message {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c33;
            padding: 12px 20px;
            border-radius: 12px;
            margin: 10px 20px;
            text-align: center;
            font-size: 14px;
            border-left: 4px solid #c33;
            box-shadow: 0 2px 8px rgba(204, 51, 51, 0.15);
            animation: errorShake 0.5s ease;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* Quick action suggestions */
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding: 0 24px 16px;
        }
        
        .quick-action-btn {
            padding: 10px 18px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }
        
        .quick-action-btn:hover {
            background: #00AED5;
            color: white;
            border-color: #00AED5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 174, 213, 0.3);
        }
        
        /* Feedback buttons */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            opacity: 0;
            animation: fadeIn 0.3s ease 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .feedback-btn {
            padding: 6px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            background: #fafbfc;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        
        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .feedback-btn.helpful:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .feedback-btn.not-helpful:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        .feedback-btn.selected {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .feedback-btn.helpful.selected {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .feedback-btn.not-helpful.selected {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        .feedback-thank-you {
            margin-top: 6px;
            font-size: 12px;
            color: #10b981;
            font-style: italic;
            animation: fadeIn 0.3s ease;
        }
        
        /* End-of-session feedback modal */
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .feedback-modal.show {
            display: flex;
        }
        
        .feedback-modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .feedback-modal h2 {
            color: #00AED5;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .star-rating {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .star {
            font-size: 36px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .star:hover,
        .star.selected {
            color: #fbbf24;
            transform: scale(1.2);
        }
        
        .feedback-question {
            margin: 20px 0;
        }
        
        .feedback-question label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .feedback-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .feedback-textarea:focus {
            border-color: #00AED5;
            box-shadow: 0 0 0 3px rgba(0, 174, 213, 0.1);
        }
        
        .feedback-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .feedback-modal-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .feedback-modal-btn.primary {
            background: linear-gradient(135deg, #00AED5 0%, #0088A8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 174, 213, 0.3);
        }
        
        .feedback-modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 174, 213, 0.4);
        }
        
        .feedback-modal-btn.secondary {
            background: #f0f0f0;
            color: #4a5568;
        }
        
        .feedback-modal-btn.secondary:hover {
            background: #e2e8f0;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .message-wrapper {
                max-width: 85%;
            }
            
            .chat-header h1 {
                font-size: 20px;
            }
            
            .chat-header p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <img src="https://sbf-lex-web-ui-112273805787.s3.ap-southeast-2.amazonaws.com/Logo-SBF.svg" 
                 alt="SBF Logo" 
                 class="chat-header-logo"
                 onerror="this.style.display='none'">
            <div class="chat-header-text">
                <h1>MCPP Digital Assistant</h1>
                <p>Ask me about Mid-Career Pathways Programme (MCPP)</p>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>Online</span>
                </div>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-wrapper">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        Hi! I am MCPP Bot. Let me assist you with our programme information and application process for host organisations. Start the conversation by typing your question.
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" onclick="sendQuickAction('What is MCPP?')">üìö What is MCPP?</button>
            <button class="quick-action-btn" onclick="sendQuickAction('How to apply?')">‚úçÔ∏è How to apply?</button>
            <button class="quick-action-btn" onclick="sendQuickAction('Eligibility criteria')">‚úÖ Eligibility</button>
            <button class="quick-action-btn" onclick="sendQuickAction('Funding information')">üí∞ Funding</button>
        </div>
        
        <div class="chat-input-container">
            <input type="text" id="userInput" placeholder="Authenticating..." autocomplete="off" disabled>
            <button id="sendButton" disabled>Send</button>
        </div>
    </div>
    
    <!-- Feedback Modal -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-modal-content">
            <h2>How was your experience?</h2>
            <p style="text-align: center; color: #718096; font-size: 14px; margin-bottom: 16px;">
                Your feedback is important to us and helps us improve!
            </p>
            
            <div class="feedback-question">
                <label>Rate your overall satisfaction (optional):</label>
                <div class="star-rating" id="starRating">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
            </div>
            
            <div class="feedback-question">
                <label>Did you find what you were looking for? (optional)</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="foundAnswer" value="true">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="foundAnswer" value="false">
                        <span>No</span>
                    </label>
                </div>
            </div>
            
            <div class="feedback-question">
                <label>Additional comments (optional):</label>
                <textarea class="feedback-textarea" id="feedbackComment" placeholder="Share your thoughts..."></textarea>
            </div>
            
            <div class="feedback-modal-buttons">
                <button class="feedback-modal-btn secondary" onclick="closeFeedbackModal()">Skip</button>
                <button class="feedback-modal-btn primary" onclick="submitSessionFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>

    <script>
        // AWS Configuration
        const CONFIG = {
            region: 'ap-southeast-2',
            userPoolId: 'ap-southeast-2_6C9UmSBnz',
            clientId: 'acjtn7ec52hglsmefqu3ogvv7',
            identityPoolId: 'ap-southeast-2:36409d79-ab2e-4847-bacf-0f8a2487df96',
            botId: 'OS5VBHBSI2',
            botAliasId: 'OGPRYXXVF4',
            localeId: 'en_US'
        };

        // Initialize AWS SDK
        AWS.config.region = CONFIG.region;
        
        // Initialize Cognito User Pool
        const poolData = {
            UserPoolId: CONFIG.userPoolId,
            ClientId: CONFIG.clientId
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        let currentUser = userPool.getCurrentUser();
        
        // Enable logging for debugging
        AWS.config.logger = console;
        
        let lexruntime = null;
        const sessionId = 'web-ui-' + Date.now() + '-' + Math.random().toString(36).substring(7);
        let credentialsReady = false;
        let messageCount = 0;
        let selectedRating = 0;
        
        // Check authentication on load
        if (!currentUser) {
            window.location.href = 'login.html'; // Redirect to login
        }
        
        // Initialize credentials and Lex client asynchronously
        currentUser.getSession(function(err, session) {
            if (err || !session.isValid()) {
                console.error('Session error:', err);
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Session valid, configuring credentials...');
            
            // Configure AWS credentials with authenticated token
            const idToken = session.getIdToken().getJwtToken();
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: CONFIG.identityPoolId,
                Logins: {
                    [`cognito-idp.${CONFIG.region}.amazonaws.com/${CONFIG.userPoolId}`]: idToken
                }
            });
            
            // Refresh credentials and wait for completion
            AWS.config.credentials.refresh(function(error) {
                if (error) {
                    console.error('Error refreshing credentials:', error);
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('Credentials refreshed successfully');
                
                // Now that credentials are ready, initialize Lex client
                lexruntime = new AWS.LexRuntimeV2();
                credentialsReady = true;
                
                // Enable the send button and update placeholder
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.placeholder = 'Type your message...';
                userInput.focus();
                
                console.log('Lex client initialized, ready to chat');
            });
        });
        
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        console.log('AWS Config:', CONFIG);
        console.log('Session ID:', sessionId);

        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.dataset.turnIndex = messageCount;
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'message-wrapper';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = isUser ? 'YOU' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (!isUser) {
                // Format bot responses: clean, simple formatting
                let formatted = text
                    // STEP 0: CRITICAL - Remove any "WICA" that slipped through and replace with "Insurance"
                    .replace(/\bWICA\b/gi, 'Insurance')
                    .replace(/Work Injury Compensation Act/gi, 'Insurance')
                    
                    // STEP 0.5: CRITICAL - Remove WSG URLs completely
                    .replace(/https?:\/\/[^\s]*wsg\.gov\.sg[^\s]*/gi, '')
                    
                    // STEP 1: Remove angle brackets around URLs first
                    .replace(/<(https?:\/\/[^\s>]+)>/gi, '$1')
                    .replace(/<(go\.gov\.sg\/[^\s>]+)>/gi, 'https://$1')
                    
                    // STEP 3: Convert bullet points (- item or ‚Ä¢ item) BEFORE URL conversion
                    .replace(/^[‚Ä¢\-]\s+(.+)$/gm, '<li>$1</li>')
                    
                    // STEP 4: Convert numbered lists (1. item)
                    .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
                    
                    // STEP 5: Convert double newlines to paragraph breaks, single newlines to <br>
                    .replace(/\n\n+/g, '</p><p>')  // Double newlines = new paragraph
                    .replace(/\n/g, '<br>')         // Single newlines = line break
                    
                    // STEP 6: Wrap consecutive <li> elements in <ul>
                    .replace(/(<li>.*?<\/li>(?:<br>)?)+/g, function(match) {
                        return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
                    })
                    
                    // STEP 7: NOW convert URLs to clickable links (after structure is set)
                    .replace(/(?<!href="|">)(https?:\/\/[^\s<>"]+?)(?=[\s<]|$)/gi, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>')
                    
                    // STEP 8: Convert bold (**text** or __text__)
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/__(.+?)__/g, '<strong>$1</strong>')
                    
                    // STEP 9: Convert italic (*text* or _text_) - avoid matching ** or __
                    .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                    .replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em>$1</em>')
                    
                    // STEP 10: Wrap in paragraph tags if not already structured
                    .replace(/^(?!<[pu]|<li)/gm, '<p>');  // Start paragraphs
                
                // Wrap entire content if needed
                if (!formatted.startsWith('<p') && !formatted.startsWith('<ul')) {
                    formatted = '<p>' + formatted + '</p>';
                }
                
                // STEP 11: Clean up excessive <br> tags and spacing
                formatted = formatted
                    .replace(/(<br>\s*){3,}/g, '<br><br>')
                    .replace(/<br><\/p>/g, '</p>')
                    .replace(/<p><br>/g, '<p>')
                    .replace(/<\/ul><br>/g, '</ul>')
                    .replace(/<br><ul>/g, '<ul>');
                
                contentDiv.innerHTML = formatted;
                
                wrapperDiv.appendChild(avatarDiv);
                wrapperDiv.appendChild(contentDiv);
                
                messageCount++;
            } else {
                contentDiv.textContent = text;
                wrapperDiv.appendChild(avatarDiv);
                wrapperDiv.appendChild(contentDiv);
            }
            
            messageDiv.appendChild(wrapperDiv);
            
            // Insert before typing indicator
            chatMessages.insertBefore(messageDiv, typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Hide quick actions after first user message
            if (isUser && document.getElementById('quickActions')) {
                document.getElementById('quickActions').style.display = 'none';
            }
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.insertBefore(errorDiv, typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            
            // Check if credentials are ready
            if (!credentialsReady || !lexruntime) {
                showError('Authentication in progress, please wait...');
                return;
            }

            console.log('Sending message:', text);

            // Disable input
            sendButton.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage(text, true);
            userInput.value = '';

            // Show typing indicator
            showTyping();

            const params = {
                botId: CONFIG.botId,
                botAliasId: CONFIG.botAliasId,
                localeId: CONFIG.localeId,
                sessionId: sessionId,
                text: text
            };

            console.log('Lex parameters:', params);

            try {
                // Ensure credentials are still valid
                await AWS.config.credentials.getPromise();
                console.log('Credentials confirmed valid');

                const data = await lexruntime.recognizeText(params).promise();
                console.log('Lex response:', data);
                
                hideTyping();
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        if (message.content) {
                            addMessage(message.content, false);
                        }
                    });
                } else {
                    console.warn('No messages in response:', data);
                    addMessage('I received your message but have no response.', false);
                }
            } catch (error) {
                console.error('Detailed error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                hideTyping();
                
                let errorMessage = 'Sorry, there was an error processing your request.';
                if (error.code === 'AccessDeniedException') {
                    errorMessage = 'Access denied. Please check IAM permissions for Lex V2.';
                } else if (error.code === 'ResourceNotFoundException') {
                    errorMessage = 'Bot not found. Please verify bot ID and alias.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
                
                // Start inactivity timer after bot responds
                startInactivityTimer();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Quick action handler
        function sendQuickAction(text) {
            userInput.value = text;
            sendMessage();
        }
        
        // Feedback functions
        
        
        // Star rating handler
        document.getElementById('starRating').addEventListener('click', (e) => {
            if (e.target.classList.contains('star')) {
                selectedRating = parseInt(e.target.dataset.rating);
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            }
        });
        
        async function submitSessionFeedback() {
            const foundAnswerRadios = document.querySelectorAll('input[name="foundAnswer"]');
            let foundAnswer = null; // Default to null if not selected
            foundAnswerRadios.forEach(radio => {
                if (radio.checked) {
                    foundAnswer = radio.value === 'true';
                }
            });
            
            const comment = document.getElementById('feedbackComment').value;
            
            // Make rating optional - if not selected, skip modal
            if (selectedRating === 0) {
                console.log('No rating provided, closing modal');
                closeFeedbackModal();
                return;
            }
            
            console.log('Submitting session feedback:', {
                rating: selectedRating,
                foundAnswer: foundAnswer,
                comment: comment || null
            });
            
            try {
                const dynamodb = new AWS.DynamoDB.DocumentClient({region: CONFIG.region});
                
                const sessionFeedback = {
                    overall_satisfaction: selectedRating,
                    timestamp: new Date().toISOString()
                };
                
                // Only add foundAnswer if it was explicitly selected
                if (foundAnswer !== null) {
                    sessionFeedback.found_answer = foundAnswer;
                }
                
                // Only add comment if provided
                if (comment && comment.trim()) {
                    sessionFeedback.comment = comment.trim();
                }
                
                const updateParams = {
                    TableName: 'SBF-ConversationLogs',
                    Key: { session_id: sessionId },
                    UpdateExpression: 'SET session_feedback = :f, last_updated = :u',
                    ExpressionAttributeValues: {
                        ':f': sessionFeedback,
                        ':u': new Date().toISOString()
                    }
                };
                
                await dynamodb.update(updateParams).promise();
                console.log('Session feedback saved successfully');
                
                closeFeedbackModal();
                
                // Show thank you message
                const thankYouDiv = document.createElement('div');
                thankYouDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    font-weight: 600;
                `;
                thankYouDiv.textContent = '‚úì Thank you for your feedback!';
                document.body.appendChild(thankYouDiv);
                
                setTimeout(() => {
                    thankYouDiv.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Error saving session feedback:', error);
                alert('Failed to save feedback. Please try again.');
            }
        }
        
        function showFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('show');
        }
        
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('show');
        }
        
        // Simplified Feedback System
        let feedbackShown = false;
        let inactivityTimer = null;
        const INACTIVITY_THRESHOLD = 10000; // 10 seconds for testing
        const MIN_MESSAGES_FOR_FEEDBACK = 5;
        
        // Satisfaction keywords for immediate feedback
        const SATISFACTION_KEYWORDS = ['thank you', 'thanks', 'thank', 'appreciate'];
        
        function checkSatisfactionSignal(message) {
            const lowerMsg = message.toLowerCase().trim();
            const isShortMessage = message.split(' ').length <= 5;
            const hasGratitude = SATISFACTION_KEYWORDS.some(keyword => lowerMsg.includes(keyword));
            return isShortMessage && hasGratitude;
        }
        
        function startInactivityTimer() {
            // Clear any existing timer
            clearTimeout(inactivityTimer);
            
            // Only start timer if we have enough messages and haven't shown feedback
            if (!feedbackShown && messageCount >= MIN_MESSAGES_FOR_FEEDBACK) {
                console.log(`Starting ${INACTIVITY_THRESHOLD/1000}s inactivity timer... (messageCount: ${messageCount})`);
                inactivityTimer = setTimeout(() => {
                    console.log(`${INACTIVITY_THRESHOLD/1000}s inactivity reached, showing feedback`);
                    showFeedbackPrompt();
                }, INACTIVITY_THRESHOLD);
            } else {
                console.log(`Inactivity timer NOT started - feedbackShown: ${feedbackShown}, messageCount: ${messageCount}, required: ${MIN_MESSAGES_FOR_FEEDBACK}`);
            }
        }
        
        function showFeedbackPrompt() {
            if (feedbackShown) return;
            feedbackShown = true;
            showFeedbackModal();
            console.log('Feedback modal shown');
        }
        
        // Exit intent: Store pending feedback on tab close
        window.addEventListener('beforeunload', () => {
            if (!feedbackShown && messageCount >= MIN_MESSAGES_FOR_FEEDBACK) {
                sessionStorage.setItem('pendingFeedback', sessionId);
            }
        });
        
        // Show pending feedback on page load
        window.addEventListener('load', () => {
            const pendingFeedback = sessionStorage.getItem('pendingFeedback');
            if (pendingFeedback && !feedbackShown) {
                setTimeout(() => {
                    showFeedbackPrompt();
                    sessionStorage.removeItem('pendingFeedback');
                }, 2000);
            }
        });
        
        // Make functions globally available
        window.sendQuickAction = sendQuickAction;
        
        window.submitSessionFeedback = submitSessionFeedback;
        window.closeFeedbackModal = closeFeedbackModal;
    </script>
</body>
</html>
